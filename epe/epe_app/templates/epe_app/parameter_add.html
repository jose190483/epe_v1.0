{% extends "epe_app/base.html" %}
{% load widget_tweaks %}
{% block content %}

<div class="container my-4">
  <form method="POST" action="">
    {% csrf_token %}

    <div class="card shadow-sm">
      <div class="card-header bg-dark text-white text-center">
        <h5 class="mb-0">Add/Update Parameter</h5>
      </div>
      <div class="card-body bg-light">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">ID</span>
              {% render_field p_form.p_id class="form-control bg-secondary text-white" id="p_id" disabled="True" %}
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Parameter Name(As Is)</span>
              {% render_field p_form.p_name_as_is class="form-control" id="p_name_as_is" %}
            </div>

          </div>

          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">System Name</span>
              {% render_field p_form.p_system id="p_system" class="form-select select2"  %}
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">System short Name</span>
              {% render_field p_form.p_system_short id="p_system_short" class="select2"  %}
            </div>
          </div>

          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text" >Equipment Name</span>
              {% render_field p_form.p_equipment_name id="p_equipment_name" class="form-select select2" %}
            </div>
          </div>

          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Equipment Short Name</span>
              {% render_field p_form.p_equipment_short id="p_equipment_short" class=" select2"  %}
            </div>
          </div>

          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Parameter Definition</span>
              {% render_field p_form.p_definition id="p_definition" class="form-select select2" %}
            </div>
          </div>

          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Measurement System</span>
              {% render_field p_form.p_parameter_unit_measurement id="p_parameter_unit_measurement" class="form-select select2" %}
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Unit Type</span>
              {% render_field p_form.p_unit_type id="p_unit_type" class="form-select select2" %}
            </div>
          </div>

          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">UOM</span>
              {% render_field p_form.p_uom id="p_uom" class="form-select select2" %}
            </div>
          </div>
          <div class="col-md-6">
          <div class="input-group input-group-sm mb-2">
            <span class="input-group-text">Digital Source</span>
            {% render_field p_form.p_digital_source class="form-select select2" multiple="multiple" %}
          </div>
          </div>
          <div class="col-md-6">
          <div class="input-group input-group-sm mb-2">
            <span class="input-group-text">Owner</span>
            {% render_field p_form.p_owner class="form-select select2" %}
          </div>
          </div>
          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Parameter Name</span>
              {% render_field p_form.p_name class="form-control" %}
            </div>
          </div>

          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Parameter Name Combo</span>
              {% render_field p_form.p_parameter_name_combo id="p_parameter_name_combo" class="form-control"  %}
            </div>
          </div>

          <div class="d-flex col justify-content-center ">
            {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} py-1 mb-2">
              {{ message }}
            </div>
            {% endfor %}
          </div>

        </div>

        <div class="d-flex justify-content-between mt-4">
          <button type="submit" class="btn btn-sm btn-success">
            <i class="fas fa-check"></i> Submit
          </button>
          <a href="{% url 'parameter_list' %}" class="btn btn-sm btn-danger">
            <i class="fas fa-times"></i> Cancel
          </a>
        </div>
      </div>
    </div>
  </form>
</div>
<div class="container" id="param_def_lov" style="display:none;">
  {% include "epe_app/parameter_definition_lov_list_woh.html" %}
</div>
{% endblock content %}

{% block scripts %}
<script>
  $(document).ready(function () {
    const paramCombo = "{{ parameter_combo }}";
    const paramDataType = parseInt("{{ parameter_data_type }}");

    $("#p_parameter_name_combo").val(paramCombo);
    $("#p_parameter_def_data_type").val(paramDataType);

    const paramDefId = $("#p_definition").val();
    const paramDefLovVal = $("#pdl_parameter_definition").val();

    // Sync the LOV field with the parameter definition ID
    if (!paramDefLovVal) {
      $("#pdl_parameter_definition").val(paramDefId);
    } else {
      $("#pdl_parameter_definition").val(paramDefLovVal);
    }
    // Show/hide the param_def_lov div based on data type
    if (paramDataType === 5) {
      $("#param_def_lov").show();
    } else {
      $("#param_def_lov").hide();
    }

  });
</script>

<script>
  $(document).ready(function () {
    $("#p_system").on("change", function () {
      const system_id = $(this).val();

      if (!system_id || system_id === "0") {
        $("#p_system_short, #p_equipment_name").empty().append("<option value='0'>--Select--</option>")
                .prop("disabled", true).trigger('change.select2');
        $("#p_equipment_short").empty().append("<option value='0'>--Select--</option>")
                .prop("disabled", true).trigger('change.select2');
        return;
      }

      $.ajax({
        url: "{% url 'load_system_short_name_equipment_name' %}",
        data: {
          system_id: system_id,
        },
        success: function (data) {
          try {
            const parsed = JSON.parse(data);

            const systemNames = parsed.system_short_name || [];
            const systemIds = parsed.system_short_name_id || [];
            const equipmentNames = parsed.equipment_name || [];
            const equipmentIds = parsed.equipment_name_id || [];

            // Populate System Short Name dropdown
            const $systemShort = $("#p_system_short");
            $systemShort.empty().append("<option value='0'>--Select--</option>");
            for (let i = 0; i < systemNames.length; i++) {
              $systemShort.append(`<option value="${systemIds[i]}">${systemNames[i]}</option>`);
            }

            $systemShort.prop("disabled", false).trigger("change.select2");

            // Populate Equipment Name dropdown
            const $equipmentName = $("#p_equipment_name");
            $equipmentName.empty().append("<option value='0'>--Select--</option>");
            for (let i = 0; i < equipmentNames.length; i++) {
              $equipmentName.append(`<option value="${equipmentIds[i]}">${equipmentNames[i]}</option>`);
            }
            $equipmentName.prop("disabled", false).trigger("change.select2");

            // Reset Equipment Short Name
            $("#p_equipment_short").empty().append("<option value='0'>--Select--</option>")
                    .prop("disabled", true).trigger('change.select2');

          } catch (e) {
            console.error("Invalid JSON response:", e);
            alert("Error parsing system or equipment data.");
          }
        },
        error: function (xhr, status, error) {
          console.error("AJAX error:", error);
          alert("Failed to load system short name and equipment.");
        }
      });
    });
  });
</script>

<script>
  $(document).ready(function () {
    $("#p_equipment_name").on("change", function () {
      var equipment_id = $(this).val();

      if (!equipment_id || equipment_id === "0") {
        // Reset dropdown if no equipment selected
        $("#p_equipment_short").empty().append("<option value='0'>--Select--</option>").prop("disabled", true).trigger('change.select2');
        return;
      }

      $.ajax({
        url: "{% url 'load_equipment_short_name' %}",
        data: {
          equipment_id: equipment_id,
        },
        success: function (data) {
          try {
            var parsed = JSON.parse(data);

            var names = parsed["equipment_short_name"] || [];
            var ids = parsed["equipment_short_name_id"] || [];

            var $dropdown = $("#p_equipment_short");
            $dropdown.empty().append("<option value='0'>--Select--</option>");

            for (var i = 0; i < names.length; i++) {
              $dropdown.append(`<option value="${ids[i]}">${names[i]}</option>`);
            }

            $dropdown.prop("disabled", false).trigger('change.select2');  // Refresh Select2 UI
          } catch (e) {
            console.error("Invalid JSON in response", e);
            alert("Something went wrong while loading equipment short names.");
          }
        },
        error: function (xhr, status, error) {
          console.error("AJAX error:", error);
          alert("Failed to load equipment short names.");
        }
      });
    });
  });
</script>

<script>
  $(document).ready(function () {
    $("#p_parameter_unit_measurement").on("change", function () {
      const measurement_system_id = $(this).val();

      if (!measurement_system_id || measurement_system_id === "0") {
        // Reset dependent dropdowns
        $("#p_unit_type").empty().append("<option value='0'>--Select--</option>").prop("disabled", true).trigger('change.select2');
        $("#p_uom").empty().append("<option value='0'>--Select--</option>").prop("disabled", true).trigger('change.select2');
        return;
      }

      $.ajax({
        url: "{% url 'load_units_type' %}",
        data: {
          measurement_system_id: measurement_system_id,
        },
        success: function (data) {
          try {
            const parsed = JSON.parse(data);
            const names = parsed.unit_type_name || [];
            const ids = parsed.unit_type_id || [];

            const $unitType = $("#p_unit_type");
            const $uom = $("#p_uom");

            $unitType.empty().append("<option value='0'>--Select--</option>");
            $uom.empty().append("<option value='0'>--Select--</option>");

            for (let i = 0; i < ids.length; i++) {
              $unitType.append(`<option value="${ids[i]}">${names[i]}</option>`);
            }

            $unitType.prop("disabled", false).trigger("change.select2");
            $uom.prop("disabled", true).trigger("change.select2"); // will be loaded on unit type change

          } catch (err) {
            console.error("Failed to parse JSON:", err);
            alert("Error loading unit types.");
          }
        },
        error: function (xhr, status, error) {
          console.error("AJAX error:", error);
          alert("Failed to load unit types.");
        }
      });
    });
  });
</script>

<script>
  $(document).ready(function () {
    $("#p_unit_type").on("change", function () {
      const unit_type_id = $(this).val();
      const system_measurement = $("#p_parameter_unit_measurement").val();

      if (!unit_type_id || unit_type_id === "0") {
        $("#p_uom").empty().append("<option value='0'>--Select--</option>").prop("disabled", true).trigger("change.select2");
        return;
      }

      $.ajax({
        url: "{% url 'load_unit_of_measure' %}",
        data: {
          unit_type_id: unit_type_id,
          system_measurement: system_measurement,
        },
        success: function (data) {
          try {
            const parsed = JSON.parse(data);
            const uomNames = parsed.uom_name || [];
            const uomIds = parsed.uom_id || [];

            const $uom = $("#p_uom");
            $uom.empty().append("<option value='0'>--Select--</option>");

            for (let i = 0; i < uomIds.length; i++) {
              $uom.append(`<option value="${uomIds[i]}">${uomNames[i]}</option>`);
            }

            $uom.prop("disabled", false).trigger("change.select2");

          } catch (err) {
            console.error("Failed to parse UOM data:", err);
            alert("Error loading units of measure.");
          }
        },
        error: function (xhr, status, error) {
          console.error("AJAX error:", error);
          alert("Failed to load UOM options.");
        }
      });
    });
  });
</script>

{% endblock scripts %}
