{% extends "epe_app/base.html" %}
{% load widget_tweaks %}
{% block content %}

<div class="container my-4">
  <form method="POST" action="">
    {% csrf_token %}

    <div class="card shadow-sm">
      <div class="card-header bg-dark text-white text-center">
        <h5 class="mb-0">Add/Update Parameter</h5>
      </div>
      <div class="card-body bg-light" id="parameter_form_id">
        <div class="row g-3">
          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">ID</span>
              {% render_field p_form.p_id class="form-control bg-secondary text-white" id="p_id" disabled="True" %}
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Parameter Name(As Is)</span>
              {% render_field p_form.p_name_as_is class="form-control" id="p_name_as_is" %}
            </div>

          </div>

          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">System Name</span>
              {% render_field p_form.p_system id="p_system" class="form-select select2"  %}
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">System short Name</span>
              {% render_field p_form.p_system_short id="p_system_short" class="select2"  %}
            </div>
          </div>

          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text" >Equipment Name</span>
              {% render_field p_form.p_equipment_name id="p_equipment_name" class="form-select select2" %}
            </div>
          </div>

          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Equipment Short Name</span>
              {% render_field p_form.p_equipment_short id="p_equipment_short" class=" select2"  %}
            </div>
          </div>

          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Parameter Definition</span>
              {% render_field p_form.p_definition id="p_definition" class="form-select select2" %}
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Unit Type</span>
              {% render_field p_form.p_unit_type id="p_unit_type" class="form-select" %}
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">UOM</span>
              {% render_field p_form.p_uom id="p_uom" class="form-select select2" %}
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group input-group-sm mb-2">
              <span class="input-group-text">Digital Source</span>
              {% render_field p_form.p_digital_source class="form-select select2" multiple="multiple" %}
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group input-group-sm mb-2">
              <span class="input-group-text">Owner</span>
              {% render_field p_form.p_owner class="form-select select2" %}
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Parameter Prefix</span>
              {% render_field p_form.p_parameter_prefix class="form-control" %}
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Parameter Name</span>
              {% render_field p_form.p_name class="form-control" %}
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Parameter Suffix</span>
              {% render_field p_form.p_parameter_suffix class="form-control" %}
            </div>
          </div>

          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Parameter Name Combo</span>
              {% render_field p_form.p_parameter_name_combo id="p_parameter_name_combo" class="form-control" readonly="True" %}
            </div>
          </div>
          <div class="col-md-6">
            <div class="input-group input-group-sm">
              <span class="input-group-text">Status</span>
              {% render_field p_form.p_status id="p_status" class="form-select"  %}
            </div>
          </div>
        </div>

        {% render_field p_form.p_updated_by id="p_updated_by" class="form-select" hidden="True" %}


        <div class="d-flex col justify-content-center mt-4">
          {% for message in messages %}
          <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} py-1 mb-2">
            {{ message }}
          </div>
          {% endfor %}
        </div>

        <div class="d-flex justify-content-between mt-4">
          <button type="submit" class="btn btn-sm btn-success">
            <i class="fas fa-check"></i> Submit
          </button>
          <a href="{% url 'parameter_list' %}" class="btn btn-sm btn-danger">
            <i class="fas fa-times"></i> Cancel
          </a>
        </div>
      </div>
    </div>
  </form>
</div>
<div class="container" id="param_def_lov" style="display:none;">
  {% include "epe_app/parameter_definition_lov_list_woh.html" %}
</div>
{% endblock content %}

{% block scripts %}
<script>
  $(document).ready(function () {
    const paramDataType = parseInt("{{ parameter_data_type }}");
    const user_role = parseInt("{{ request.session.ses_userID }}");
    const parameter_status= document.getElementById("p_status").value
    if(parameter_status === "4" && user_role !== 1) {
      alert("You do not have permission to edit this record.");
      $('.card-body').find('input, select, textarea, button').prop('disabled', true);
      $(".container").find('button,table,a').prop('disabled', true);
    }

    $("#p_parameter_def_data_type").val(paramDataType);

    const paramDefId = $("#p_definition").val();
    const paramDefLovVal = $("#pdl_parameter_definition").val();

    // Sync the LOV field with the parameter definition ID
    if (!paramDefLovVal) {
      $("#pdl_parameter_definition").val(paramDefId);
    } else {
      $("#pdl_parameter_definition").val(paramDefLovVal);
    }
    // Show/hide the param_def_lov div based on docs type
    if (paramDataType === 5) {
      $("#param_def_lov").show();
    } else {
      $("#param_def_lov").hide();
    }
    document.getElementById("p_updated_by").value =({{ request.session.ses_userID }});
  });
</script>

<script>
  $(document).ready(function () {
    $("#p_system").on("change", function () {
      const system_id = $(this).val();

      if (!system_id || system_id === "0") {
        $("#p_system_short, #p_equipment_name, #p_equipment_short").empty()
          .append("<option value='0'>--Select--</option>");
        return;
      }

      $.ajax({
        url: "{% url 'load_system_short_name_equipment_name' %}",
        data: { system_id: system_id },
        success: function (data) {
          try {
            // system_short_name is a single value
            const systemName = data.system_short_name || "";
            const systemId = data.system_short_name_id || "";

            const equipmentNames = data.equipment_name || [];
            const equipmentIds = data.equipment_name_id || [];

            // Populate System Short Name dropdown
            const $systemShort = $("#p_system_short");
            $systemShort.empty().append("<option value='0'>--Select--</option>");
            $systemShort.append(`<option value="${systemId}">${systemName}</option>`);
            $systemShort.val(systemId);

            // Populate Equipment Name dropdown
            const $equipmentName = $("#p_equipment_name");
            $equipmentName.empty().append("<option value='0'>--Select--</option>");
            for (let i = 0; i < equipmentIds.length; i++) {
              $equipmentName.append(`<option value="${equipmentIds[i]}">${equipmentNames[i]}</option>`);
            }

            // Reset Equipment Short Name dropdown
            $("#p_equipment_short").empty().append("<option value='0'>--Select--</option>");

          } catch (e) {
            console.error("Invalid JSON response:", e);
            alert("Error parsing system or equipment data.");
          }
        },
        error: function (xhr, status, error) {
          console.error("AJAX error:", error);
          alert("Failed to load system short name and equipment.");
        }
      });
    });
  });
</script>


<script>
  $(document).ready(function () {
    $("#p_equipment_name").on("change", function () {
      const equipment_id = $(this).val();

      if (!equipment_id || equipment_id === "0") {
        $("#p_equipment_short").empty()
          .append("<option value='0'>--Select--</option>")
          .prop("disabled", true);
        return;
      }

      $.ajax({
        url: "{% url 'load_equipment_short_name' %}",
        data: { equipment_id: equipment_id },
        success: function (data) {
          try {
            const name = data.equipment_short_name || "";
            const id = data.equipment_short_name_id || "";

            const $dropdown = $("#p_equipment_short");
            $dropdown.empty().append("<option value='0'>--Select--</option>");
            $dropdown.append(`<option value="${id}">${name}</option>`);
            $dropdown.prop("disabled", false).val(id);

          } catch (e) {
            console.error("Invalid JSON in response", e);
            alert("Something went wrong while loading equipment short names.");
          }
        },
        error: function (xhr, status, error) {
          console.error("AJAX error:", error);
          alert("Failed to load equipment short names.");
        }
      });
    });
  });
</script>


<script>
  $(document).ready(function () {
    $("#p_definition").on("change", function () {
      const parameter_definition_id = $(this).val();
      if (!parameter_definition_id || parameter_definition_id === "0") {
        $("#p_unit_type").empty().append("<option value='0'>--Select--</option>").prop("disabled", true);
        $("#p_uom").empty().append("<option value='0'>--Select--</option>").prop("disabled", true);
        return;
      }

      $.ajax({
        url: "{% url 'load_units_type' %}",
        data: { parameter_definition_id: parameter_definition_id },
        success: function (data) {
          try {
            const unit_type = data.unit_type || "";
            const unit_type_id = data.unit_type_id || "";
            const uom_name = data.uom_name || [];
            const uom_id = data.uom_id || [];

            // Populate Unit Type dropdown
            const $unitType = $("#p_unit_type");
            $unitType.empty().append("<option value='0'>--Select--</option>");
            $unitType.append(`<option value="${unit_type_id}">${unit_type}</option>`);
            $unitType.prop("disabled", false).val(unit_type_id);

            // Populate UOM dropdown
            const $uom = $("#p_uom");
            $uom.empty().append("<option value='0'>--Select--</option>");
            for (let i = 0; i < uom_id.length; i++) {
              $uom.append(`<option value="${uom_id[i]}">${uom_name[i]}</option>`);
            }
            $uom.prop("disabled", false);

          } catch (err) {
            console.error("Failed to process response:", err);
            alert("Error loading unit types.");
          }
        },
        error: function (xhr, status, error) {
          console.error("AJAX error:", error);
          alert("Failed to load unit types.");
        }
      });
    });
  });
</script>



{% endblock scripts %}
