{% extends "epe_app/base.html" %}
{% load widget_tweaks %}
{% block content %}
<div class="container-fluid">
    <!-- File upload form -->
    <form id="upload-pdf-form" method="post" enctype="multipart/form-data" class="mb-3">
        {% csrf_token %}
        <div class="input-group">
            <input type="file" id="pdf-file" name="pdf_file" class="form-control" accept="application/pdf" required>
            <button type="submit" class="btn btn-success">Upload PDF</button>
        </div>
    </form>

    <div class="card mb-3">
        <div class="card-header bg-dark text-white text-center">
            <h2>Chat Box</h2>
        </div>
        <div class="card-body d-flex flex-column" style="height: 80vh;">

            <!-- Chat history container -->
            <div id="chat-history" class="flex-grow-1 overflow-auto mb-3 border rounded p-3" style="white-space: normal; overflow-x: hidden;">
    {% if chat_history %}
    {% for entry in chat_history %}
    <div class="chat-entry p-3 mb-3 border rounded">
        <div class="prompt-container mb-2">
            <strong class="d-block">User:</strong>
            <p class="mb-2 border rounded p-2 bg-light text-wrap">{{ entry.prompt }}</p>
        </div>
        <div class="response-container">
            <strong class="d-block">Response:</strong>
            <p class="mb-2 border rounded p-2 bg-light text-wrap">{{ entry.response }}</p>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <p class="text-muted">No chat history available.</p>
    {% endif %}
</div>

            <!-- Input prompt at the bottom -->
            <form id="chat-form" method="post" enctype="multipart/form-data" class="mt-auto">
                {% csrf_token %}
                <div class="input-group">
                    <input type="text" id="prompt" name="prompt" class="form-control" placeholder="Enter your prompt..." required>
                    <button type="submit" class="btn btn-primary">Send</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
    document.getElementById('chat-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const prompt = document.getElementById('prompt').value;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        fetch("{% url 'read_pdf_prompt' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ prompt })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const chatHistory = document.getElementById('chat-history');
                const entry = document.createElement('div');
                entry.className = 'border p-2 mb-2';
                entry.innerHTML = `
                    <strong>User:</strong>
                    <p>${data.prompt}</p>
                    <strong>Response:</strong>
                    <p>${data.response}</p>
                `;
                chatHistory.appendChild(entry);
                chatHistory.scrollTop = chatHistory.scrollHeight; // Scroll to the bottom
                document.getElementById('prompt').value = '';
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    });
</script>

<script>
    document.getElementById('upload-pdf-form').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        fetch("{% url 'upload_pdf' %}", { // Corrected endpoint
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('PDF uploaded and processed successfully!');
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => console.error('Error:', error));
    });
</script>
{% endblock scripts %}