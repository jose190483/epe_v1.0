{% extends "epe_app/base.html" %}
{% block content %}
<div class="container-fluid py-4">
    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white text-center">
                <h5 class="mb-0">Parameter Comparison </h5>
            </div>
            <div class="card-body bg-light" id="parameter_form_id">
                <div class="row g-3">

                    <div class="col-md-6">
                        <label for="system" class="form-label"><h6>System:</h6></label>
                        <select name="system" id="system" class="form-select" required>
                            {% for system in systems %}
                            <option value="{{ system.id }}">{{ system.system_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label for="equipment" class="form-label"><h6>Equipment:</h6></label>
                        <select name="equipment" id="equipment" class="form-select" required>
                            {% for equipment in equipments %}
                            <option value="{{ equipment.id }}">{{ equipment.equipment_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="as_is_pdf" class="form-label"><h6>Upload As-Is PDF:</h6></label>
                        <input type="file" name="as_is_pdf" id="as_is_pdf" class="form-control" accept="application/pdf" required>
                    </div>

                    <div class="col-md-6">
                        <label for="to_be_pdf" class="form-label"><h6>Upload To-Be PDF:</h6></label>
                        <input type="file" name="to_be_pdf" id="to_be_pdf" class="form-control" accept="application/pdf" required>
                    </div>
                </div>

                <div class="d-flex col justify-content-center mt-4">
                    {% for message in messages %}
                    <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} py-1 mb-2">
                        {{ message }}
                    </div>
                    {% endfor %}
                </div>

                <div class="d-flex justify-content-between mt-4">

                    <button type="submit" name="analyze" class="btn btn-sm btn-success">
                        <i class="fas fa-check"></i> Submit
                    </button>

                    <a href="{% url 'home_page' %}" class="btn btn-sm btn-danger">
                        <i class="fas fa-times"></i> Cancel
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<!--as-is document analysis-->
<div class="container-fluid mb-3">
    <div class="card">
        <div class="card-header bg-dark text-white text-center">
            <h5>As-Is Document Analysis</h5>
        </div>
        <div class="card-body">
            <div class="row g-4 m-2">
                <!-- Left Column: Accordion with 3 tables -->
                <div class="col-lg-6 col-md-12">
                    <div class="accordion" id="asIsAccordion">
                        <!-- Keywords Found -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="asIsHeadingFound">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#asIsCollapseFound" aria-expanded="true" aria-controls="asIsCollapseFound">
                                    Keywords Found
                                </button>
                            </h2>
                            <div id="asIsCollapseFound" class="accordion-collapse collapse show" aria-labelledby="asIsHeadingFound" data-bs-parent="#asIsAccordion">
                                <div class="accordion-body">
                                    <div class="table-responsive">
                                        <table id="as_is_list" class="table table-striped table-bordered table-sm nowrap">
                                            <thead class="table-dark">
                                            <tr><th>Keyword Found</th></tr>
                                            </thead>
                                            <tbody>
                                            {% for kw, matches in as_is_results.found_summary.items %}
                                            {% for match in matches %}
                                            <tr><td>{{ kw }}</td></tr>
                                            {% endfor %}
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Keywords Not Found -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="asIsHeadingNotFound">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#asIsCollapseNotFound" aria-expanded="false" aria-controls="asIsCollapseNotFound">
                                    Keywords Not Found
                                </button>
                            </h2>
                            <div id="asIsCollapseNotFound" class="accordion-collapse collapse" aria-labelledby="asIsHeadingNotFound" data-bs-parent="#asIsAccordion">
                                <div class="accordion-body">
                                    <div class="table-responsive">
                                        <table id="as_is_keyword_not_matched_list" class="table table-striped table-bordered table-sm nowrap">
                                            <thead class="table-dark">
                                            <tr><th>Keyword Not Found</th></tr>
                                            </thead>
                                            <tbody>
                                            {% for kw in as_is_results.not_found_keywords %}
                                            <tr><td>{{ kw }}</td></tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Duplicate Keywords -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="asIsHeadingDuplicate">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#asIsCollapseDuplicate" aria-expanded="false" aria-controls="asIsCollapseDuplicate">
                                    Duplicate Keywords
                                </button>
                            </h2>
                            <div id="asIsCollapseDuplicate" class="accordion-collapse collapse" aria-labelledby="asIsHeadingDuplicate" data-bs-parent="#asIsAccordion">
                                <div class="accordion-body">
                                    <div class="table-responsive">
                                        <table id="as_is_duplicate_keyword_list" class="table table-striped table-bordered table-sm nowrap">
                                            <thead class="table-dark">
                                            <tr><th>Duplicate Keyword</th></tr>
                                            </thead>
                                            <tbody>
                                            {% for kw in as_is_results.duplicate_keywords_list %}
                                            <tr><td>{{ kw }}</td></tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Download PDF -->
                <div class="col-lg-6 col-md-12">
                    <div class="container_fluid shadow-box-table m-2 p-3">
                        <div class="d-flex justify-content-center">
                            <h5 class="shadow-sm rounded text-center bg-info text-white p-2">As-Is Document Summary</h5>
                        </div>
                        {% if as_is_results %}
                        <ul>
                            <li>PDF Scanned: {{ as_is_results.pdfs_scanned }}</li>
                            <li>Keywords Entered: {{ as_is_results.keywords_entered }}</li>
                            <li>Keywords Matched: {{ as_is_results.keywords_matched }}</li>
                            <li>Keywords Not Found: {{ as_is_results.keywords_not_found }}</li>
                            <li>Duplicate Keywords: {{ as_is_results.duplicate_keywords }}</li>
                        </ul>
                        {% endif %}
                    </div>

                    <div class="accordion" id="asIsDownloadAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="asIsHeadingDownload">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#asIsCollapseDownload" aria-expanded="true" aria-controls="asIsCollapseDownload">
                                    Download PDFs
                                </button>
                            </h2>
                            <div id="asIsCollapseDownload" class="accordion-collapse collapse show" aria-labelledby="asIsHeadingDownload" data-bs-parent="#asIsDownloadAccordion">
                                <div class="accordion-body">
                                    <div class="table-responsive">
                                        <table id="as_is_download_list" class="table table-striped table-bordered table-sm nowrap">
                                            <thead class="table-dark">
                                            <tr><th>Download PDF</th></tr>
                                            </thead>
                                            <tbody>
                                            {% for pdf in as_is_pdf_files %}
                                            <tr>
                                                <td class="text-center">
                                                    <a target="_blank" href="{% url 'download_marked_pdf' pdf %}"> {{ pdf }}</a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--to be document analysis-->
<div class="container-fluid mb-3">
    <div class="card">
        <div class="card-header bg-dark text-white text-center">
            <h5>To-Be Document Analysis</h5>
        </div>
        <div class="card-body">
            <div class="row g-4 m-2">
                <!-- Left Column: Keyword Tables -->
                <div class="col-lg-6 col-md-12">
                    <div class="accordion" id="keywordAccordion">
                        <!-- Keyword Found -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFound">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseFound" aria-expanded="true" aria-controls="collapseFound">
                                    Keyword Found
                                </button>
                            </h2>
                            <div id="collapseFound" class="accordion-collapse collapse show" aria-labelledby="headingFound" data-bs-parent="#keywordAccordion">
                                <div class="accordion-body">
                                    <div class="table-responsive">
                                        <table id="to_be_list" class="table table-striped table-bordered border-secondary-subtle table-sm nowrap">
                                            <thead class="table-dark">
                                            <tr><th>Keyword Found</th></tr>
                                            </thead>
                                            <tbody>
                                            {% for kw, matches in to_be_results.found_summary.items %}
                                            {% for match in matches %}
                                            <tr><td>{{ kw }}</td></tr>
                                            {% endfor %}
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Keyword Not Found -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingNotFound">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseNotFound" aria-expanded="false" aria-controls="collapseNotFound">
                                    Keyword Not Found
                                </button>
                            </h2>
                            <div id="collapseNotFound" class="accordion-collapse collapse" aria-labelledby="headingNotFound" data-bs-parent="#keywordAccordion">
                                <div class="accordion-body">
                                    <div class="table-responsive">
                                        <table id="to_be_keyword_not_matched_list" class="table table-striped table-bordered border-secondary-subtle table-sm nowrap">
                                            <thead class="table-dark">
                                            <tr><th>Keyword Not Found</th></tr>
                                            </thead>
                                            <tbody>
                                            {% for kw in to_be_results.not_found_keywords %}
                                            <tr><td>{{ kw }}</td></tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Duplicate Keyword -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingDuplicate">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDuplicate" aria-expanded="false" aria-controls="collapseDuplicate">
                                    Duplicate Keyword
                                </button>
                            </h2>
                            <div id="collapseDuplicate" class="accordion-collapse collapse" aria-labelledby="headingDuplicate" data-bs-parent="#keywordAccordion">
                                <div class="accordion-body">
                                    <div class="table-responsive">
                                        <table id="to_be_duplicate_keyword_list" class="table table-striped table-bordered border-secondary-subtle table-sm nowrap">
                                            <thead class="table-dark">
                                            <tr><th>Duplicate Keyword</th></tr>
                                            </thead>
                                            <tbody>
                                            {% for kw in to_be_results.duplicate_keywords_list %}
                                            <tr><td>{{ kw }}</td></tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column: PDF Table -->
                <div class="col-lg-6 col-md-12">
                    <div class="container_fluid shadow-box-table m-2 p-3">
                        <div class="d-flex justify-content-center">
                            <h5 class="shadow-sm rounded text-center bg-info text-white p-2">To-Be Document Summary</h5>
                        </div>
                        {% if to_be_results %}
                        <ul>
                            <li>PDF Scanned: {{ to_be_results.pdfs_scanned }}</li>
                            <li>Keywords Entered: {{ to_be_results.keywords_entered }}</li>
                            <li>Keywords Matched: {{ to_be_results.keywords_matched }}</li>
                            <li>Keywords Not Found: {{ to_be_results.keywords_not_found }}</li>
                            <li>Duplicate Keywords: {{ to_be_results.duplicate_keywords }}</li>
                        </ul>
                        {% endif %}
                    </div>
                    <div class="accordion" id="pdfAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingPDF">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePDF" aria-expanded="true" aria-controls="collapsePDF">
                                    Download PDF Files
                                </button>
                            </h2>
                            <div id="collapsePDF" class="accordion-collapse collapse show" aria-labelledby="headingPDF" data-bs-parent="#pdfAccordion">
                                <div class="accordion-body">
                                    <div class="table-responsive">
                                        <table id="to_be_download_list" class="table table-striped table-bordered border-secondary-subtle table-sm nowrap">
                                            <thead class="table-dark">
                                            <tr><th>Download PDF</th></tr>
                                            </thead>
                                            <tbody>
                                            {% for pdf in to_be_pdf_files %}
                                            <tr>
                                                <td class="text-center">
                                                    <a target="_blank" href="{% url 'download_marked_pdf' pdf %}"> {{ pdf }}</a>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--similarity scores-->
<div class="container-fluid">
    <div class="card">
        <div class="card-header bg-dark text-white text-center">
            <h5>Parameter Definition vs Name Matching</h5>
        </div>
        <div class="card-body">
            {% if similarity_scores %}

            <div class="d-flex justify-content-center">
                <h5 class="shadow-sm rounded text-center bg-info text-white p-2">Parameter Definition vs Name Matching</h5>
            </div>
            <table id="similarity_list"  class="table table-striped table-bordered border-secondary-subtle  table-sm nowrap mt-2">
                <thead class="table-dark">
                <tr>
                    <th>Parameter</th>
                    <th>Definition</th>
                    <th>Matching Score</th>
                </tr>
                </thead>
                <tbody>
                {% for row in similarity_scores %}
                <tr>
                    <td>{{ row.parameter }}</td>
                    <td>{{ row.parameter_definition }}</td>
                    <td>{{ row.matching_score|floatformat:2 }}</td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const options = {
            responsive: true,
            order: [[0, 'desc']],
            dom: '<"row align-items-center mb-3"' +
                    '<"col-md-4"l>' +        // Length dropdown
                    '<"col-md-4 text-center"B>' + // Export buttons
                    '<"col-md-4 text-end"f>' +    // Search box
                '>rt' +
                '<"row mt-3"' +
                    '<"col-md-6"i>' +        // Table info
                    '<"col-md-6 text-end"p>' +  // Pagination
                '>',
            buttons: ['copy', 'excel', 'pdf']
        };

        new DataTable('#as_is_list', options);
        new DataTable('#to_be_list', options);
        new DataTable('#similarity_list', options);
        new DataTable('#duplicate_keyword_list', options);
        new DataTable('#keyword_not_matched_list', options);
        new DataTable('#as_is_keyword_not_matched_list', options);
        new DataTable('#as_is_duplicate_keyword_list', options);
        new DataTable('#as_is_download_list', options);
        new DataTable('#to_be_keyword_not_matched_list', options);
        new DataTable('#to_be_duplicate_keyword_list', options);
        new DataTable('#to_be_download_list', options);

    });
</script>


{% endblock scripts %}
